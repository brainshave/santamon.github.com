<!DOCTYPE html>
<html lang="pl">
  <head>
    <meta charset="utf-8" />
    <link rel="alternate" type="application/atom+xml" title="Long-standing Bug" href="atom.xml" />
    <link rel="stylesheet" href="media/main.css" />

    <title>Błąd młodego parsownika</title>
    <!-- work around IE (8?) not handling properly unknown tags -->
    <!-- suggested here: http://diveintohtml5.org/semantics.html -->
    <script>
      document.createElement("article");
      document.createElement("nav");
      document.createElement("aside");
      document.createElement("footer");
      document.createElement("time");
    </script>
  </head>
  <body>
    <div id="main_container">
      <div id="left_container">
        <header>
          <a href="index.html" id="logo"><img src="media/header.svg" /></a>
        </header>
        <article id="content">
  <time>2010-09-03</time>
  <h1>Błąd młodego parsownika</h1>
  

<p><strong>Parsownik</strong> &mdash; <em>osoba pisząca parsery.<br />(Termin zawdzięczam
  mojemubratu.)</em></p>

<p>Od pierwszego wpisu tutaj minęły 2 tygodnie. Najlepsze jest to, że
zacząłem pisać następny wpis już następnego dnia po wystartowaniu
bloga. Cały wpis powstał bez sprawdzania czy kompiluje się ładnie do
HTML-a. Po ukończeniu skompilował się, niestety źle. Bardzo
źle. Tagi przeplatały się w nieprawidłowy sposób, np. gwiazdka gdzieś
wcześniej w którymś paragrafie i gwiazdka gdzieś dalej w wypunktowaniu
powodowały otoczenie to tagiem <code>&lt;b&gt;</code>. Co dawało np. takie wyjście:</p>

<div class="highlight"><pre><code class="html">... <span class="nt">&lt;p&gt;</span> ... <span class="nt">&lt;b&gt;</span> ... <span class="nt">&lt;/p&gt;</span>
<span class="nt">&lt;ul&gt;</span> <span class="nt">&lt;li&gt;</span> ... <span class="nt">&lt;/b&gt;</span> ...
</code></pre>
</div>


<p>Mój parser działał ogólnie tak, że miał listę par: wyrażenie regularne
+ funkcja, która wywoływana była na tekście do którego zostało
dopasowane to wyrażenie. Aby zapobiec złemu przeplataniu się
tagów wyrażenia ozdobników (takich jak pogrubienie, pochylenie,
podkreślenie; do tego używam pojedynczych znaków, np:
<code>/asdf/</code> → <code>&lt;em&gt;asdf&lt;/em&gt;</code>)
stały się bardzo skomplikowane. Mam na myśli coś takiego
(<code>@</code> to odpowiednik dla znacznika <code>&lt;code&gt;</code>):</p>

<div class="highlight"><pre><code class="python"><span class="s">r&quot;(?&lt;!&lt;|\w|[@])\@(?=\S)([^@]+)(?&lt;=\S)\@(?=\W)&quot;</span>
</code></pre>
</div>


<p>Nie jestem specjalistą od wyrażeń regularnych ale użycie ich wydawało
mi się bardzo obiecujące. Szczególnie łatwo było na początku ;).</p>

<p>Przedstawione podejście miało poważne wady:</p>

<ol>
<li>za każdym razem przetwarzany był cały tekst,</li>
<li>wyrażenia widziały go jako sam tekst a nie jako strukturę,</li>
<li>w praktyce dopuszczalne było przeplatanie się znaczników HTML j/w.</li>
</ol>


<p>Ogólnie całość sprawiała wrażenie jakby trzymała się na rzęsach :P.
Ciągłe dopasowywanie regexpów mogło się szybko skończyć kodem
spaghetti&hellip; Jednym słowem&hellip;</p>

<h2>Porażka :D.</h2>

<p>Mogłem spodziewać się tego po przeczytaniu
<a href="http://stackoverflow.com/questions/1732348/regex-match-open-tags-except-xhtml-self-contained-tags/1732454">tego wątku na Stack Overflow</a>.
Dotyczył on parsowania HTML-a więc najpierw pomyślałem, że moja
wymarzona składnia nie jest aż tak trudna do przetworzenia.</p>

<p>Wróciłem do Stack Overflow jak mój parser zaczął nawalać&hellip;</p>

<h2>Pyparsing</h2>

<blockquote><p>Have you tried using an XML parser instead?<br />
&mdash; <a href="http://stackoverflow.com/questions/1732348/regex-match-open-tags-except-xhtml-self-contained-tags/1732454#1732454">Will</a></p></blockquote>

<p>Wow. To mi dało myślenia. Oczywiście nie chodziło o użycie parsera XML-a
ale śladem &ldquo;gotowych, dobrze sprawdzonych rozwiązań&rdquo; trafiłem na
<a href="http://pyparsing.wikispaces.com/">pyparsing</a>.</p>

<p>Pyparsing jest (dla mnie, laika z tego tematu :P ) parserem dowolnie
zdefiniowanej gramatyki. Od np. <a href="http://www.antlr.org/">ANTLR-a</a> różni się
tym, że gramatykę definiuje się za pomocą wyrażeń w Pythonie (używając
zwykłych operatorów takich jak <code>+</code> czy <code>|</code>)
zamiast tradycyjnego <a href="http://pl.wikipedia.org/wiki/Notacja_EBNF">EBNF</a>.</p>

<p>Idealnie dla mnie. Wystarczyło zrozumieć filozofię działania,
przeczytać
<a href="http://pyparsing.svn.sourceforge.net/viewvc/pyparsing/src/HowToUsePyparsing.html">krótką i przystępną instrukcję</a>
oraz czasem zajrzeć do
<a href="http://packages.python.org/pyparsing/">dokumentacji API</a>.</p>

<h3>Prosty przykład</h3>

<p>Skoro jesteśmy przy moich <strong>pogrubieniach</strong> za pomocą gwiazdki i
<em>pochyleniach</em> za pomocą ukośnika, proponuję prosty, rekurencyjny przykład.</p>

<p>Najpierw wersja nierekurencyjna:</p>

<div class="highlight"><pre><code class="python"><span class="c"># -*- coding: utf-8 -*-</span>
<span class="kn">from</span> <span class="nn">pyparsing</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pprint</span>

<span class="n">undecorated</span> <span class="o">=</span> <span class="n">OneOrMore</span><span class="p">(</span> <span class="c"># tłumaczy się samo przez się</span>
                         <span class="n">Word</span><span class="p">(</span> <span class="c"># słowo (przynajmniej 1 znak) złożone z:</span>
                               <span class="n">alphanums</span><span class="p">))</span> <span class="c"># litery i cyfry</span>

<span class="n">bold</span> <span class="o">=</span> <span class="s">&quot;*&quot;</span> <span class="o">+</span> <span class="n">undecorated</span> <span class="o">+</span> <span class="s">&quot;*&quot;</span>   <span class="c"># prawda,</span>
<span class="n">italic</span> <span class="o">=</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="n">undecorated</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="c"># że proste? :)</span>

<span class="c"># metoda parseString() służy do... parsowania napisów</span>
<span class="n">pprint</span><span class="p">(</span><span class="n">bold</span><span class="o">.</span><span class="n">parseString</span><span class="p">(</span><span class="s">&quot;*asdf*&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">asList</span><span class="p">())</span>
<span class="n">pprint</span><span class="p">(</span><span class="n">italic</span><span class="o">.</span><span class="n">parseString</span><span class="p">(</span><span class="s">&quot;/qwer/&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">asList</span><span class="p">())</span>
</code></pre>
</div>


<p>Wynikiem tego będzie:</p>

<div class="highlight"><pre><code class="python"><span class="p">[</span><span class="s">&#39;*&#39;</span><span class="p">,</span> <span class="s">&#39;asdf&#39;</span><span class="p">,</span> <span class="s">&#39;*&#39;</span><span class="p">]</span>
<span class="p">[</span><span class="s">&#39;/&#39;</span><span class="p">,</span> <span class="s">&#39;qwer&#39;</span><span class="p">,</span> <span class="s">&#39;/&#39;</span><span class="p">]</span>
</code></pre>
</div>


<p>Jak widać, pyparsing dzieli łańcuch na kawałki określone w gramatyce
(tokeny). Domyślnie omija też ew. białe znaki pomiędzy nimi.</p>

<p>Rekurencyjny przykład będzie nieco dłuższy. Ponieważ Python nie pozwala
na używanie niezdefiniowanych symboli pyparsing załatwia to
klasą <code>Forward</code>, która umożliwia najpierw zadeklarowanie elementu
a później podanie jego definicji za pomocą operatora <code>&lt;&lt;</code>.</p>

<div class="highlight"><pre><code class="python"><span class="c"># -*- coding: utf-8 -*-</span>
<span class="kn">from</span> <span class="nn">pyparsing</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pprint</span>

<span class="n">undecorated</span> <span class="o">=</span> <span class="n">OneOrMore</span><span class="p">(</span> <span class="n">Word</span><span class="p">(</span><span class="n">alphanums</span><span class="p">))</span>

<span class="n">bold</span> <span class="o">=</span> <span class="n">Forward</span><span class="p">()</span>
<span class="n">italic</span> <span class="o">=</span> <span class="n">Forward</span><span class="p">()</span>

<span class="n">expression</span> <span class="o">=</span> <span class="n">OneOrMore</span><span class="p">(</span> <span class="n">undecorated</span> <span class="o">|</span> <span class="n">bold</span> <span class="o">|</span> <span class="n">italic</span> <span class="p">)</span>

<span class="c"># Domyślnie wszystkie elementy odnalezione przez pyparsing</span>
<span class="c"># zwracane są jako jednowymiarowa lista, Group stworzy</span>
<span class="c"># listę zagnieżdżoną dla tego dopasowania</span>
<span class="n">bold</span> <span class="o">&lt;&lt;</span> <span class="n">Group</span><span class="p">(</span><span class="s">&quot;*&quot;</span> <span class="o">+</span> <span class="n">expression</span> <span class="o">+</span> <span class="s">&quot;*&quot;</span><span class="p">)</span>
<span class="n">italic</span> <span class="o">&lt;&lt;</span> <span class="n">Group</span><span class="p">(</span><span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="n">expression</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span><span class="p">)</span>

<span class="n">pprint</span><span class="p">(</span><span class="n">expression</span><span class="o">.</span><span class="n">parseString</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">czysty tekst</span>
<span class="s">/krzywo/ *grubo*</span>
<span class="s">/*krzywo grubo*/ */grubo krzywo/*</span>
<span class="s">*grubo /krzywo i jeszcze raz *grubo*/*</span>
<span class="s">&quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">asList</span><span class="p">())</span>
</code></pre>
</div>


<p>Tym razem wyjście wygląda tak:</p>

<div class="highlight"><pre><code class="python"><span class="p">[</span><span class="s">&#39;czysty&#39;</span><span class="p">,</span> <span class="s">&#39;tekst&#39;</span><span class="p">,</span>        <span class="c"># czysty tekst</span>
 <span class="p">[</span><span class="s">&#39;/&#39;</span><span class="p">,</span> <span class="s">&#39;krzywo&#39;</span><span class="p">,</span> <span class="s">&#39;/&#39;</span><span class="p">],</span>     <span class="c"># /krzywo/</span>
 <span class="p">[</span><span class="s">&#39;*&#39;</span><span class="p">,</span> <span class="s">&#39;grubo&#39;</span><span class="p">,</span> <span class="s">&#39;*&#39;</span><span class="p">],</span>      <span class="c"># *grubo*</span>
 <span class="p">[</span><span class="s">&#39;/&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;*&#39;</span><span class="p">,</span> <span class="s">&#39;krzywo&#39;</span><span class="p">,</span> <span class="s">&#39;grubo&#39;</span><span class="p">,</span> <span class="s">&#39;*&#39;</span><span class="p">],</span> <span class="s">&#39;/&#39;</span><span class="p">],</span> <span class="c"># /*krzywo grubo*/</span>
 <span class="p">[</span><span class="s">&#39;*&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;/&#39;</span><span class="p">,</span> <span class="s">&#39;grubo&#39;</span><span class="p">,</span> <span class="s">&#39;krzywo&#39;</span><span class="p">,</span> <span class="s">&#39;/&#39;</span><span class="p">],</span> <span class="s">&#39;*&#39;</span><span class="p">],</span> <span class="c"># */grubo krzywo/*</span>
 <span class="p">[</span><span class="s">&#39;*&#39;</span><span class="p">,</span> <span class="s">&#39;grubo&#39;</span><span class="p">,</span>
  <span class="p">[</span><span class="s">&#39;/&#39;</span><span class="p">,</span> <span class="s">&#39;krzywo&#39;</span><span class="p">,</span> <span class="s">&#39;i&#39;</span><span class="p">,</span> <span class="s">&#39;jeszcze&#39;</span><span class="p">,</span> <span class="s">&#39;raz&#39;</span><span class="p">,</span>
   <span class="p">[</span><span class="s">&#39;*&#39;</span><span class="p">,</span> <span class="s">&#39;grubo&#39;</span><span class="p">,</span> <span class="s">&#39;*&#39;</span><span class="p">],</span>
   <span class="s">&#39;/&#39;</span><span class="p">],</span>
  <span class="s">&#39;*&#39;</span><span class="p">]]</span>
</code></pre>
</div>


<p>Ostatni kawałek jest szczególnie ciekawy. Zostawiam go
do samodzielnego przeanalizowania :P. Dla mnie to była eureka,
która pozwoliła mi dalej popchnąć projekt :)</p>

<p>Oba przykłady umieszczone są w <a href="olt/input/blad-mlodego-parsownika.py">jednym pliku</a>.
Plik ten posiada jeszcze jeden cukierek dla osób wnikliwych ;).
Przedstawiony przykład jest uproszczeniem analogicznego kodu
z mojego <a href="http://github.com/santamon/makeblog/blob/master/txt-to-html/txt-to-html.py">parsera</a>.</p>

<p>Takie drzewko jak w ostatnim listingu możemy już dowolnie przetworzyć
manipulując listami, albo użyć metody <code>setParseAction(fn)</code> na każdym
zdefiniowanym elemencie gramatyki, gdzie <code>fn</code> to funkcja.
Jeśli <code>fn</code> zwróci jakąś wartość to element w drzewie zostanie
zastąpiony tą wartością.</p>

<h2>Podsumowanie</h2>

<p>Nowy parser pozbawiony jest wad poprzedniego, przede wszystkim:</p>

<ol>
<li>działa,</li>
<li>jest bardziej przewidywalny,</li>
<li>kod jest bardziej przejrzysty,</li>
<li>jest łatwiej rozszerzalny.</li>
</ol>


<p>Polecam przyjrzeć się <a href="http://pyparsing.wikispaces.com/">pyparsing</a>
jeśli mamy potrzebę/chęć przetworzenia jakiegoś tekstu i piszemy w
Pythonie. Jeszcze raz podaję adres do
<a href="http://pyparsing.svn.sourceforge.net/viewvc/pyparsing/src/HowToUsePyparsing.html">samouczka</a>
oraz do <a href="http://packages.python.org/pyparsing/">dokumentacji API</a>.
Pyparsing ma bardzo fajną licencję
(<a href="http://www.opensource.org/licenses/mit-license.php">MIT</a>), &ldquo;róbta co
chceta ale pochwalcie się od kogo ściągaliście&rdquo; :P ) i jest dość
popularne, co znaczy, że powinna być dostępna w Twojej Ulubionej
Dystrybucji ;).</p>



<div>
<div id="disqus_thread"></div>
<script type="text/javascript">
  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  var disqus_shortname = 'longstandingbug'; // required: replace example with your forum shortname

  // The following are highly recommended additional parameters. Remove the slashes in front to use.
  
  
  
  var disqus_identifier = 'blad-mlodego-parsownika.html';
  var disqus_url = 'http://longstandingbug.com/blad-mlodego-parsownika.html';

  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
</div>


</article>

      </div>
      <div id="right_container">
        <nav id="meta_menu">
          <a href="index.html">Home</a><br />
          <a href="atom.xml">Atom</a><br />
          <a href="info.html">Author</a><br />
          <a href="http://twitter.com/szywon">Twitter</a><br />
          <a href="http://github.com/santamon">GitHub</a>
        </nav>
        <nav id="projects_menu">
          <p>Projects:</p>
          <a href="http://github.com/santamon/GUIFTW">GUI FTW!</a><br />
          <a href="http://github.com/santamon/slideshow-bob">Slideshow Bob</a>
        </nav>
        <nav id="catogries_menu">
          <p>Categories:</p>
          <a href="clojure-category.html">Clojure</a><br />
          <a href="gui-ftw-category.html">GUI</a><br />
          <a href="javascript-category.html">JavaScript</a>
        </nav>
        <nav id="links_menu">
          <p>Links:</p>
          <a href="http://radek.pycka.com">Radek Pycka</a><br />
          <a href="http://blog.charmas.pl">Michał Charmas</a><br />
          <a href="http://konradhalas.blogspot.com/">Konrad Hałas</a><br />
          <a href="http://infoq.com">InfoQ</a>
        </nav>
        <nav id="archive_menu">
          <p>Archive:</p>
          
          




<label for="September_2011">September 2011</label>
<input id="September_2011" type="checkbox" />
<ul>



<li><time datetime="2011-09-11">
    11
</time> <a href="/whys-behind-new-design.html">The Whys Behind This New Freaky Design</a></li>




</ul>
<label for="June_2011">June 2011</label>
<input id="June_2011" type="checkbox" />
<ul>



<li><time datetime="2011-06-20">
    20
</time> <a href="/sound-synthesis.html">Sound Synthesis & Playback in Clojure</a></li>




</ul>
<label for="May_2011">May 2011</label>
<input id="May_2011" type="checkbox" />
<ul>



<li><time datetime="2011-05-22">
    22
</time> <a href="/webglol.html">WebGLOL</a></li>






<li><time datetime="2011-05-16">
    16
</time> <a href="/reintroducing-guiftw.html">Reintroducing GUI FTW! and Progress Report</a></li>






<li><time datetime="2011-05-07">
    7
    
</time> <a href="/restarting-in-english-mode.html">Restarting in English Mode</a></li>




</ul>
<label for="April_2011">April 2011</label>
<input id="April_2011" type="checkbox" />
<ul>



<li><time datetime="2011-04-04">
    4
    
</time> <a href="/zdarzenia-guiftw.html">Zdarzenia w GUI FTW!</a></li>




</ul>
<label for="March_2011">March 2011</label>
<input id="March_2011" type="checkbox" />
<ul>



<li><time datetime="2011-03-20">
    20
</time> <a href="/niech-sie-stanie-gui-ftw.html">Niech się stanie GUI FTW!</a></li>




</ul>
<label for="October_2010">October 2010</label>
<input id="October_2010" type="checkbox" />
<ul>



<li><time datetime="2010-10-16">
    16
</time> <a href="/idea-iluzja.html">Idea i Iluzja łeb w web</a></li>




</ul>
<label for="September_2010">September 2010</label>
<input id="September_2010" type="checkbox" />
<ul>



<li><time datetime="2010-09-03">
    3
    
</time> <a href="/blad-mlodego-parsownika.html">Błąd młodego parsownika</a></li>




</ul>
<label for="August_2010">August 2010</label>
<input id="August_2010" type="checkbox" />
<ul>



<li><time datetime="2010-08-16">
    16
</time> <a href="/intro.html">Intro</a></li>




</ul>
<label for="January_2010">January 2010</label>
<input id="January_2010" type="checkbox" />
<ul>



<li><time datetime="2010-01-07">
    7
    
</time> <a href="/efekty-uboczne-programowania.html">Efekty uboczne programowania</a></li>




</ul>
<label for="June_2009">June 2009</label>
<input id="June_2009" type="checkbox" />
<ul>



<li><time datetime="2009-06-07">
    7
    
</time> <a href="/one-makefile-to-rule-them-all.html">One Makefile To Rule Them All</a></li>


</ul>


        </nav>
      </div>
    </div>
    <footer><div>Copywrong 2011 Szymon Witamborski</div></footer>
    <script src="media/hyphenator.js"></script>
    <!-- google analytics -->
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-23922729-1']);
      _gaq.push(['_trackPageview']);

      (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
  </body>
</html>
